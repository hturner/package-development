<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Function Documentation and Dependencies</title>
    <meta charset="utf-8" />
    <meta name="author" content=" Dr Heather Turner RSE Fellow, University of Warwick, UK " />
    <meta name="date" content="2022-07-28" />
    <script src="libs/header-attrs-2.14/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="extra.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Function Documentation and Dependencies
]
.author[
### <br>Dr Heather Turner<br>RSE Fellow, University of Warwick, UK<br>
]
.date[
### 28 July 2022
]

---





# Functions: Documentation and the NAMESPACE

- Documenting functions with roxygen2
- NAMESPACE: exporting functions
- NAMESPACE: importing functions

---

class: inverse middle
# Function documentation with roxygen2

---

## roxygen2

The `roxygen2` package generates documentation from specially formatted comments, that we write above the function code, e.g.


```r
#' @param x A numeric vector.
```


`#'` is a Roxygen comment.

`@param` is a Roxygen tag.

The `@param` tag takes an argument: the name of the parameter

The remaining text (until the next tag in the file) is the documentation
relevant to the tag.

---

## Common tags

There are four tags you’ll use for most functions

Tag        | Purpose
---------- | -------------
@param arg | Describe inputs
@examples  | Show how the function works
@return    | Describe the return value (not needed if `NULL`)
@export    | Add this tag if the function should be user-visible

Usual RStudio shortcuts work in the @examples section, allowing you to run code interactively.

???

Other important ones:
@seealso   | Pointers to related functions
@references
@importFRom
@method
@note
@rdname
@keywords internal
@format (data)
@section

---

## The description block

The roxygen comment should start with a description block.
- First sentence is the **title**.
- Next paragraph is the **description**.
- Everything else is the **details** (optional).

```

#' Title in Title Case of up to 65 Characters
#'
#' Mandatory description of what the function does. Should be a short paragraph
#' of a few lines only.
#'
#' The details section is optional and may be several paragraphs. It can even
#' contain sub-sections (not illustrated here).
```

---

## RStudio helps you get started

Put your cursor inside a function, then select Insert Roxygen Skeleton from
the Code menu

.pull-left[
&lt;img src="insert_roxygen_skeleton.png" width="500px" /&gt;
]

.pull-right[

```r
#' Title
#'
#' @param animal
#' @param sound
#'
#' @return
#' @export
#'
#' @examples
animal_sounds &lt;- function(animal, sound) {
  stopifnot(is.character(animal) &amp; length(animal) == 1)
  stopifnot(is.character(sound) &amp; length(sound) == 1)
  message("The ", animal, " goes ", sound, "!")
}
```
]

---

## Example roxygen documentation

```r
#' Sort a Numeric Vector in Decreasing Order
#'
#' Sort a numeric vector so that the values are in deceasing order.  Missing
#' values are optionally removed or put last.
#'
#' @param x A numeric vector.
#' @param na.rm A logical value indicating whether to remove missing values
#' before sorting.
#' @return A vector with the values sorted in descreasing order.
#' @export
#'
#' @examples
#' x &lt;- c(3, 7, 2, NA)
#' high_to_low(x)
#' high_to_low(x, na.rm = TRUE)
```

---

class: clear font160

## R documentation file

roxygen2 converts the roxygen block to an `.Rd` file in the `/man` directory

```
% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/high_to_low.R
\name{high_to_low}
\alias{high_to_low}
\title{Sort a Numeric Vector in Decreasing Order}
\usage{
high_to_low(x, na.rm = FALSE)
}
\arguments{
\item{x}{A numeric vector.}
\item{na.rm}{A logical value indicating whether to remove missing values
before sorting.}
}
\value{
...
```

---

## HTML file

When the package is installed, the `.Rd` is converted by R to HTML on demand

.center[
&lt;img src="high_to_low.png" width="500px" /&gt;
]
---

## Regular documentation workflow

.center[
&lt;img src="documentation_workflow.png" width="800px" /&gt;
]
--
.center[
You must have loaded the package with
`load_all()` at least once.
]

---

class: inverse center middle

# Namespace: exports

---

## A namespace splits functions into two classes

&lt;br&gt;

Internal                    | External
--------------------------- | -------------
Only for use within package | For use by others
Documentation optional      | Must be documented
Easily changed              | Changing will break other people’s code

---

## The default NAMESPACE exports everything

```
# Generated by roxygen2: fake comment so
# roxygen2 overwrites silently.
exportPattern("^[^\\.]")
```

---

## Better to export functions explicitly

```r
#' @export
fun1 &lt;- function(...) {}
```

When we call `devtools::document()`, an `export()` directive will be added to
NAMESPACE for each function that has an `#' @export` comment.

```
# Generated by roxygen2: do not edit by hand

export(fun1)
```

---

## Export functions that people should use

Don't export internal helpers

```r
# Defaults for NULL values
`%||%` &lt;- function(a, b) if (is.null(a)) b else a

# Remove NULLs from a list
compact &lt;- function(x) {
  x[!vapply(x, is.null, logical(1))]
}
```

---

# Your turn

For the `animal_sounds` function:

1. Insert a Roxygen skeleton using the RStudio helper.
2. Create a draft documentation file with `devtools::document()` or
`Cmd/Ctrl + Shift + D`.
3. Click on "Diff" in the Git pane and view the changes that have been made.
4. Preview the HTML help with `?animal_sounds`.
5. Fill in the Roxygen skeleton for `animal_sounds()`, recreating the documentation
file and previewing the HTML help to view your updates.
5. When you have finished editing, run `devtools::document()` to ensure the
`.Rd` file is in sync. Make a git commit with your updated `R/animal_sounds.R`
file, the updated NAMESPACE, and the new `man/animal_sounds.Rd` file.

---

## .Rd Markup

`.Rd` files recognise LaTeX-like mark-up in most text-based fields, e.g.

```
#' This is a convenience function that is a wrapper around
#' \code{\link{sort.int}}.
```

Details can be found in the [Writing R documentation files](https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Writing-R-documentation-files)
section of the Writing R Extensions manual.

---

## Using markdown

Most commonly-used mark-up is easier with markdown (can be mixed with .Rd mark-up).

Text formatting: `**bold**`, `_italic_`, ` `code` `

Create links

* To a function in the same package: `[func()]`
* To a function in a different package: `[pkg::func()]`

With different link text, e.g. `[link text][func()]`

For more details, see the [(R)Markdown support](https://cran.r-project.org/web/packages/roxygen2/vignettes/rd-formatting.html) vignette.

---

## View documentation with links

To view the documentation with working links, we must install the package first.

.center[
&lt;img src="documentation_workflow2.png" width="700px" /&gt;
]

???

---

# Your turn

1. Add some details to the help package for `animalSounds()`, with a link to
`paste0()`.
2. Verify that no link is shown when recreating the documentation with the
regular workflow.
3. Create the documentation with the second workflow and look at the help file.
Does the link to `paste0()` work?
4. Commit all your changes to the git repo.

---

class: inverse center middle

# Dependencies

---

# Dependencies

Dependencies are other R packages that our package uses. There are three
types of dependency:

**Imports**: required packages, will be installed when our package is installed
if they are not already installed.

**Suggests**: optional packages, e.g. only used for development; only used in
documentation. *Not* installed automatically with our package.

**Depends**: essentially deprecated for packages, may be used to specify a
minimum required version of R (i.e., version of the core packages).

---

## Imported packages

In DESCRIPTION
&lt;pre&gt;
Imports: pkgname
&lt;/pre&gt;

Use `::` to access functions
```r
new_function &lt;- function(x, y, z) {
  pkgname::imported_function(x, y) + z
}
```

---

## Suggested packages

In DESCRIPTION
&lt;pre&gt;
Suggests: pkgname
&lt;/pre&gt;

In package functions or examples, handle the case where **pkgname** is not available
```r
if (!requireNamespace("pkgname", quietly = TRUE)){
  warning("pkgname must be installed to perform this function",
          "returning NULL")
  return(NULL)
}
```

???
Also explain conditional use in vignettes later

---

## `use_package()`

`use_package()` will modify the DESCRIPTION and remind you how to use the
function.

By default, packages will be added to "Imports".

```r
usethis::use_package("assertthat")
usethis::use_package("glue", type = "Suggests")
```

---

class: inverse center middle

# Namespace: imports

---

## You might get tired of using :: all the time

Or you might want to use an infix function
```r
`%&gt;%` &lt;- magittr::`%&gt;%`

col_summary &lt;- function(df, fun) {
  stopifnot(is.data.frame(df))

  df %&gt;%
    purrr::keep(is.numeric) %&gt;%
    purrr::modify(fun)
}

```

---

## You can **import** functions into the package

```r
#' @importFrom purrr keep modify
#' @importFrom magrittr %&gt;%
col_summary &lt;- function(df, fun) {
  stopifnot(is.data.frame(df))

  df %&gt;%
    keep(is.numeric) %&gt;%
    modify(fun)
}
```

`devtools::document()` will add corresponding `import()` statements to the
NAMESPACE, e.g. `import(purr, keep, modify)`.

Adding formal imports is slightly more efficient than using `::`.

---

## Package-level import file

Imports belong to the package, not to individual functions, so you might want
to recognise this by storing them in a central location, e.g. `R/imports.R`

```r
#' @importFrom purrr keep map
#' @importFrom magrittr %&gt;%
NULL
```

---

##  Importing everything from a package seems easy

```r
#' @import purrr
col_summary &lt;- function(df, fun) {
  stopifnot(is.data.frame(df))

  df %&gt;%
    keep(is.numeric) %&gt;%
    map_dfc(fun)
}

```

---

## But is dangerous...

```r
#' @import pkg1
#' @import pkg2
fun &lt;- function(x) {
  fun1(x) + fun2(x)
}

```

Works today...

... But next year, **pkg2** adds a `fun1` function


---

# Documenting dependencies

&lt;br&gt;

Description                 | NAMESPACE
--------------------------- | -------------
Makes **package** available | Makes function available
Mandatory                   | Optional (can use :: instead)
`use_package()`             | `#' @importFrom`

???

plus example of adding import?

---

# Example: assertthat

Currently we are using `stopifnot()` for argument validation


```r
stopifnot(is.character(animal) &amp; length(animal) == 1)
stopifnot(is.character(sound) &amp; length(sound) == 1)
```

We might instead use `assertthat::assert_that()`


```r
library(assertthat)
assert_that(is.string(animal),
            is.string(sound))
```

---

# Your Turn

1. Use `use_package()` to add `assertthat` to `Imports`.
2. Update `animal_sounds()` to use `assert_that()` to validate the arguments, using `::` to fully qualify the function calls.
3. Load all and try giving `animal_sounds()` invalid inputs for animal and/or sound.
4. Commit your changes to git.
5. Push your commits for this session.
  
---

# References

Wickham, H and Bryan, J, _R Packages_ (2nd edn, in progress), https://r-pkgs.org.

R Core Team, _Writing R Extensions_, https://cran.r-project.org/doc/manuals/r-release/R-exts.html

---

## License

&lt;a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"&gt;&lt;img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /&gt;&lt;/a&gt;&lt;br /&gt;&lt;span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"&gt;Package Development Workshop&lt;/span&gt; by &lt;a href="https://github.com/hturner"&gt;Heather Turner&lt;/a&gt; is licensed under &lt;a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"&gt;CC BY-NC-SA 4.0&lt;/a&gt;. Derivative of &lt;a href="https://github.com/forwards/workshops"&gt;Package Development Workshop&lt;/a&gt; by &lt;a href="https://forwards.github.io/about/"&gt;Forwards&lt;/a&gt;, used under &lt;a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"&gt;CC BY-NC-SA 4.0&lt;/a&gt;. 
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "googlecode",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
